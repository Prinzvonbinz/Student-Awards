<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Schüler-Auszeichnung – Abstimmung</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container" id="voteContainer">
    <h1>Schüler-Abstimmung</h1>
    <div id="codeInputSection">
      <p>Bitte gib deinen Zugangscode ein:</p>
      <input type="text" id="codeInput" maxlength="5">
      <button onclick="loadVoting()">Abstimmung starten</button>
      <p id="errorMessage" style="color:red;"></p>
    </div>
    <div id="votingSection" style="display:none;"></div>
  </div>
  <script src="vote.js"></script>
</body>
</html>
function loadVoting() {
  const codeParam = new URLSearchParams(window.location.search).get("code") || document.getElementById("codeInput").value.trim().toUpperCase();
  const data = JSON.parse(localStorage.getItem("student_awards_host"));
  if (!data || data.code !== codeParam) {
    document.getElementById("errorMessage").innerText = "Ungültiger Code.";
    return;
  }

  const deadline = new Date(data.deadline);
  if (new Date() > deadline) {
    document.getElementById("errorMessage").innerText = "Die Abstimmung ist beendet.";
    return;
  }

  if (localStorage.getItem("voted_" + data.code)) {
    document.getElementById("errorMessage").innerText = "Du hast bereits abgestimmt.";
    return;
  }

  document.getElementById("codeInputSection").style.display = "none";
  const votingSection = document.getElementById("votingSection");
  votingSection.style.display = "block";

  let html = '<label>Dein Name (optional):</label><input type="text" id="voterName"><br>';
  data.categories.forEach(cat => {
    html += `<h3>${cat}</h3>`;
    ["m", "w"].forEach(gender => {
      html += `<label>${gender === "m" ? "Jungen" : "Mädchen"}:</label><select id="${cat}_${gender}">`;
      html += '<option value="-">-</option>';
      data.students.filter(s => s.gender === gender).forEach(s => {
        html += `<option value="${s.name}">${s.name}</option>`;
      });
      html += `</select><br>`;
    });
  });

  html += `<button onclick="submitVote()">Abschicken</button>`;
  votingSection.innerHTML = html;
}

function submitVote() {
  const data = JSON.parse(localStorage.getItem("student_awards_host"));
  const vote = {};
  data.categories.forEach(cat => {
    vote[cat] = {
      m: document.getElementById(`${cat}_m`).value,
      w: document.getElementById(`${cat}_w`).value
    };
  });

  const allVotes = JSON.parse(localStorage.getItem("student_awards_votes")) || [];
  allVotes.push(vote);
  localStorage.setItem("student_awards_votes", JSON.stringify(allVotes));
  localStorage.setItem("voted_" + data.code, "true");

  alert("Danke fürs Abstimmen!");
  location.reload();
}
