<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Abstimmung - Schüler-Auszeichnung</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Schüler-Auszeichnung - Abstimmung</h1>

  <section id="login-section">
    <label for="codeInput">Bitte Zugangscode eingeben:</label><br/>
    <input type="text" id="codeInput" maxlength="5" placeholder="Zugangscode" />
    <button id="loginBtn">Weiter</button>
    <p id="loginError" style="color:red; display:none;"></p>
  </section>

  <section id="vote-section" style="display:none;">
    <form id="voteForm">
      <div id="categoriesContainer"></div>
      <button type="submit">Abgeben</button>
    </form>
    <p id="voteMessage" style="color:green; display:none;"></p>
  </section>

<script src="vote.js"></script>
</body>
</html>
// --- vote.js ---

const loginSection = document.getElementById('login-section');
const codeInput = document.getElementById('codeInput');
const loginBtn = document.getElementById('loginBtn');
const loginError = document.getElementById('loginError');

const voteSection = document.getElementById('vote-section');
const categoriesContainer = document.getElementById('categoriesContainer');
const voteForm = document.getElementById('voteForm');
const voteMessage = document.getElementById('voteMessage');

let hostData = null;

loginBtn.addEventListener('click', () => {
  const code = codeInput.value.trim().toUpperCase();
  if (!code) {
    showLoginError('Bitte Zugangscode eingeben.');
    return;
  }
  const stored = localStorage.getItem('student_awards_host');
  if (!stored) {
    showLoginError('Keine Host-Daten gefunden.');
    return;
  }
  const data = JSON.parse(stored);
  if (data.accessCode !== code) {
    showLoginError('Ungültiger Zugangscode.');
    return;
  }
  hostData = data;

  loginSection.style.display = 'none';
  voteSection.style.display = 'block';

  buildVoteForm();
});

function showLoginError(msg) {
  loginError.textContent = msg;
  loginError.style.display = 'block';
}

function buildVoteForm() {
  categoriesContainer.innerHTML = '';

  for (const cat of hostData.categories) {
    const catDiv = document.createElement('div');
    catDiv.classList.add('category');

    const title = document.createElement('h3');
    title.textContent = cat;
    catDiv.appendChild(title);

    // Junge Input
    const maleLabel = document.createElement('label');
    maleLabel.textContent = 'Junge: ';
    const maleInput = document.createElement('input');
    maleInput.type = 'text';
    maleInput.name = `${cat}_m`;
    maleInput.placeholder = 'Name Junge oder "-"';
    maleInput.required = true;
    maleLabel.appendChild(maleInput);
    catDiv.appendChild(maleLabel);

    // Mädchen Input
    const femaleLabel = document.createElement('label');
    femaleLabel.textContent = 'Mädchen: ';
    const femaleInput = document.createElement('input');
    femaleInput.type = 'text';
    femaleInput.name = `${cat}_w`;
    femaleInput.placeholder = 'Name Mädchen oder "-"';
    femaleInput.required = true;
    femaleLabel.appendChild(femaleInput);
    catDiv.appendChild(femaleLabel);

    categoriesContainer.appendChild(catDiv);
  }
}

voteForm.addEventListener('submit', e => {
  e.preventDefault();
  voteMessage.style.display = 'none';

  // Werte prüfen
  const formData = new FormData(voteForm);
  const votes = {};
  for (const cat of hostData.categories) {
    const maleName = formData.get(`${cat}_m`).trim();
    const femaleName = formData.get(`${cat}_w`).trim();

    if (!validateName(maleName, 'm') || !validateName(femaleName, 'w')) {
      alert(`Ungültige Eingabe bei Kategorie "${cat}".\nBitte gültige Namen oder "-" eingeben.`);
      return;
    }
    votes[cat] = { m: maleName, w: femaleName };
  }

  // Stimmen speichern in localStorage unter "student_awards_votes"
  // Stimmen sind ein Array von Objekten (pro Abstimmung)
  const votesStr = localStorage.getItem('student_awards_votes');
  const votesArr = votesStr ? JSON.parse(votesStr) : [];
  votesArr.push(votes);
  localStorage.setItem('student_awards_votes', JSON.stringify(votesArr));

  voteMessage.textContent = 'Vielen Dank für Ihre Abstimmung!';
  voteMessage.style.display = 'block';

  voteForm.reset();
});

function validateName(name, gender) {
  if (name === '-') return true;
  const s = hostData.students;
  for (const student of s) {
    if (student.gender === gender && student.name.toLowerCase() === name.toLowerCase()) {
      return true;
    }
  }
  return false;
}
