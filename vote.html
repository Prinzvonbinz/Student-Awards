<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Student Awards - Abstimmung</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 700px; margin: 2rem auto; padding: 1rem; background: #fafafa; }
  h1 { text-align: center; }
  #error { color: red; text-align: center; margin-bottom: 1rem; }
  #votingTable { border-collapse: collapse; width: 100%; margin-top: 1rem; }
  #votingTable th, #votingTable td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; cursor: pointer; }
  #votingTable th { background: #ddd; }
  #votingTable td.selected { background-color: #8fd18f; }
  #votingTable td.abstain { background-color: #f0a0a0; }
  #submitBtn { margin-top: 1.5rem; padding: 0.8rem 1.5rem; font-size: 1.1rem; cursor: pointer; display: block; margin-left: auto; margin-right: auto; }
  #thankyou { text-align: center; font-size: 1.2rem; color: green; margin-top: 1.5rem; }
</style>
</head>
<body>

<h1>Student Awards - Abstimmung</h1>
<div id="error"></div>

<div id="voteSection" style="display:none;">
  <table id="votingTable">
    <thead>
      <tr>
        <th>Kategorie</th>
        <th>Junge</th>
        <th>Mädchen</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <!-- Dynamisch befüllt -->
    </tbody>
  </table>

  <button id="submitBtn">Abgeben</button>
</div>

<div id="thankyou" style="display:none;">Vielen Dank für deine Teilnahme! Du kannst nicht nochmal abstimmen.</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');

  const errorDiv = document.getElementById('error');
  const voteSection = document.getElementById('voteSection');
  const thankYouDiv = document.getElementById('thankyou');
  const submitBtn = document.getElementById('submitBtn');
  const tableBody = document.getElementById('tableBody');

  if (!code) {
    errorDiv.textContent = 'Ungültiger Code! Bitte mit gültigem Link aufrufen.';
  } else {
    const rawData = localStorage.getItem(code);
    if (!rawData) {
      errorDiv.textContent = 'Ungültiger Code oder keine Daten gefunden.';
    } else {
      const data = JSON.parse(rawData);

      // Prüfen, ob User schon abgestimmt hat
      const userId = localStorage.getItem('voted-' + code);
      if (userId) {
        voteSection.style.display = 'none';
        thankYouDiv.style.display = 'block';
      } else {
        voteSection.style.display = 'block';

        const categories = data.categories;
        const students = data.students;

        // Jungs und Mädchen getrennt filtern
        const boys = students.filter(s => s.gender === 'm');
        const girls = students.filter(s => s.gender === 'w');

        // Wir bauen pro Kategorie eine Zeile mit 3 Spalten: Kategorie, Junge-Auswahl, Mädchen-Auswahl
        // In jeder Kategorie für Junge/Mädchen kann jeweils genau eine Auswahl getroffen werden (Name) oder enthaltung ('-')

        // Struktur der Auswahl: 
        // Wir speichern ausgewählte Namen je Kategorie und Geschlecht, initial '-' (Enthaltung)

        // Damit Mehrfachklicks vermeiden: pro Zelle klicken = Auswahl

        // Datenstruktur für Auswahl:
        // selections = { category1: { m: 'Name'/'-', w: 'Name'/'-' }, ... }

        const selections = {};
        categories.forEach(cat => {
          selections[cat] = { m: '-', w: '-' };
        });

        function createCell(category, gender, names) {
          const td = document.createElement('td');

          // Container div für Auswahlmöglichkeiten
          const container = document.createElement('div');
          container.style.display = 'flex';
          container.style.flexDirection = 'column';
          container.style.alignItems = 'center';
          container.style.justifyContent = 'center';
          container.style.gap = '4px';

          // Abstinenz-Button
          const abstainBtn = document.createElement('button');
          abstainBtn.textContent = '-';
          abstainBtn.style.width = '100%';
          abstainBtn.style.padding = '2px 4px';
          abstainBtn.style.cursor = 'pointer';
          abstainBtn.classList.add('abstain');
          abstainBtn.addEventListener('click', () => {
            selections[category][gender] = '-';
            updateTableHighlights();
          });
          container.appendChild(abstainBtn);

          // Für jeden Namen Button erstellen
          names.forEach(nameObj => {
            const btn = document.createElement('button');
            btn.textContent = nameObj.name;
            btn.style.width = '100%';
            btn.style.padding = '2px 4px';
            btn.style.cursor = 'pointer';
            btn.addEventListener('click', () => {
              selections[category][gender] = nameObj.name;
              updateTableHighlights();
            });
            container.appendChild(btn);
          });

          td.appendChild(container);
          return td;
        }

        function updateTableHighlights() {
          // Gehe durch alle Zeilen und zelle die ausgewählte Buttons hervor
          for(let r=0; r < tableBody.rows.length; r++) {
            const row = tableBody.rows[r];
            const cat = row.cells[0].textContent;
            ['m','w'].forEach((gender, idx) => {
              const cell = row.cells[idx +1];
              const buttons = cell.querySelectorAll('button');
              buttons.forEach(btn => {
                btn.classList.remove('selected');
              });
              // Markiere den ausgewählten Button
              const sel = selections[cat][gender];
              buttons.forEach(btn => {
                if(btn.textContent === sel) {
                  btn.classList.add('selected');
                }
              });
            });
          }
        }

        // Tabelle füllen
        categories.forEach(category => {
          const tr = document.createElement('tr');
          const catCell = document.createElement('td');
          catCell.textContent = category;
          tr.appendChild(catCell);

          tr.appendChild(createCell(category, 'm', boys));
          tr.appendChild(createCell(category, 'w', girls));

          tableBody.appendChild(tr);
        });

        updateTableHighlights();

        // Submit Handler
        submitBtn.addEventListener('click', () => {
          // Prüfen, ob für alle Kategorien in beiden Geschlechtern was ausgewählt wurde (auch '-' zählt)
          let allSet = true;
          for(const cat of categories) {
            if(!selections[cat].m) allSet = false;
            if(!selections[cat].w) allSet = false;
          }
          if(!allSet) {
            alert('Bitte in allen Kategorien bei Jungen und Mädchen eine Auswahl treffen (auch Enthaltung möglich).');
            return;
          }

          // Votes speichern: für jede Kategorie und Geschlecht wird der Name gezählt (ausgenommen '-')
          // votes Struktur: { category: { m: {name: count}, w: {name: count} } }
          if(!data.votes) data.votes = {};
          categories.forEach(cat => {
            if(!data.votes[cat]) data.votes[cat] = { m: {}, w: {} };
            ['m','w'].forEach(g => {
              const choice = selections[cat][g];
              if(choice !== '-') {
                if(!data.votes[cat][g][choice]) data.votes[cat][g][choice] = 0;
                data.votes[cat][g][choice]++;
              }
            });
          });

          // Markiere diesen Client als abgestimmt
          localStorage.setItem('voted-' + code, 'true');

          // Votes aktualisieren
          localStorage.setItem(code, JSON.stringify(data));

          voteSection.style.display = 'none';
          thankYouDiv.style.display = 'block';
        });
      }
    }
  }
</script>

</body>
</html>
