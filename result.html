<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Student Awards - Ergebnisse</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 800px; margin: 2rem auto; padding: 1rem; background: #fafafa; }
  h1, h2 { text-align: center; }
  table { border-collapse: collapse; width: 100%; margin-bottom: 2rem; }
  th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
  th { background: #ddd; }
  .category-section { margin-bottom: 3rem; }
  .no-votes { color: #888; text-align: center; margin-top: 1rem; }
</style>
</head>
<body>

<h1>Student Awards - Ergebnisse</h1>
<div id="error"></div>
<div id="results"></div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');

  const errorDiv = document.getElementById('error');
  const resultsDiv = document.getElementById('results');

  if (!code) {
    errorDiv.textContent = 'Ungültiger Code! Bitte mit gültigem Link aufrufen.';
  } else {
    const rawData = localStorage.getItem(code);
    if (!rawData) {
      errorDiv.textContent = 'Ungültiger Code oder keine Daten gefunden.';
    } else {
      const data = JSON.parse(rawData);

      if(!data.votes) {
        errorDiv.textContent = 'Noch keine Abstimmungsergebnisse vorhanden.';
        return;
      }

      const categories = data.categories;
      const students = data.students;

      // Jungs und Mädchen filtern
      const boys = students.filter(s => s.gender === 'm');
      const girls = students.filter(s => s.gender === 'w');

      // Funktion: Votes sortieren nach Stimmenzahl absteigend
      function sortedVotes(voteObj) {
        if(!voteObj) return [];
        return Object.entries(voteObj).sort((a,b) => b[1] - a[1]);
      }

      categories.forEach(category => {
        const catSection = document.createElement('div');
        catSection.classList.add('category-section');

        const catTitle = document.createElement('h2');
        catTitle.textContent = category;
        catSection.appendChild(catTitle);

        ['m','w'].forEach(gender => {
          const genderTitle = document.createElement('h3');
          genderTitle.textContent = gender === 'm' ? 'Jungen' : 'Mädchen';
          catSection.appendChild(genderTitle);

          const votes = data.votes[category] ? data.votes[category][gender] : null;

          if(!votes || Object.keys(votes).length === 0) {
            const noVotes = document.createElement('p');
            noVotes.classList.add('no-votes');
            noVotes.textContent = 'Keine Stimmen vorhanden.';
            catSection.appendChild(noVotes);
            return;
          }

          // Sortierte Ergebnisse
          const sorted = sortedVotes(votes);

          const table = document.createElement('table');
          const thead = document.createElement('thead');
          const headerRow = document.createElement('tr');
          const thName = document.createElement('th');
          thName.textContent = 'Name';
          const thVotes = document.createElement('th');
          thVotes.textContent = 'Stimmen';
          headerRow.appendChild(thName);
          headerRow.appendChild(thVotes);
          thead.appendChild(headerRow);
          table.appendChild(thead);

          const tbody = document.createElement('tbody');
          sorted.forEach(([name, count]) => {
            const tr = document.createElement('tr');
            const tdName = document.createElement('td');
            tdName.textContent = name;
            const tdCount = document.createElement('td');
            tdCount.textContent = count;
            tr.appendChild(tdName);
            tr.appendChild(tdCount);
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);
          catSection.appendChild(table);
        });

        resultsDiv.appendChild(catSection);
      });
    }
  }
</script>

</body>
</html>
